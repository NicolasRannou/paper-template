<!-- var scrollTargetEl = document.querySelector(location.hash);
       scrollTargetEl && scrollTargetEl.scrollIntoView(true, {behavior: 'smooth'});
     }, 200); -->

<polymer-element name="app-element">
<template>
  <link rel="stylesheet" href="app.css"> 
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

  <flatiron-director route="{{route}}" autoHash></flatiron-director>

  <core-drawer-panel id="drawerPanel" narrow='{{ narrow }}'>

    <!-- Drawer -->
    <core-header-panel drawer mode="waterfall">
      <core-toolbar id='drawerToolbar' class='core-header'> Navigation </core-toolbar>
      <core-menu on-core-select='{{selectActionT}}' id='iam-core-menu'>
        <template repeat="{{pages as page}}">
          <core-submenu on-core-select='{{ selectActionST }}' id='{{page.id}}-core-submenu' icons='settings' label="{{page.label}}">
            <template repeat="{{page.subpages as subpage}}">  
              <core-item label="{{subpage.label}}" hash="#{{page.label}}/{{subpage.label}}" ><a href="#{{page.label}}/{{subpage.label}}"></core-item>
            </template>
          </core-submenu>
        </template>
      </core-menu>
    </core-header-panel>

    <!-- Main -->
    <core-header-panel id='waterFallTall' main mode="waterfall-tall" on-scroll="{{scrollHandler}}">

      <!-- Main toolbar -->
      <core-toolbar id='coreTool' class="toolbar">
        <core-icon-button icon="{{$.pages.selected != 0 ? 'arrow-back' : 'menu'}}" on-tap="{{back}}"></core-icon-button>
        <div flex>Stuff</div>
        <core-icon-button icon="more-vert"></core-icon-button>
      </core-toolbar>

      <!-- Main page -->
      <div layout horizontal fit>
        <core-animated-pages id="pages" flex on-core-animated-pages-transition-end="{{transitionend}}" transitions="cross-fade-all hero-transition">
          <section vertical layout>
            <div id="container" flex horizontal wrap around-justified layout hero-p on-scroll="{{scrollHandler}}">
              <template repeat="{{item in items}}">
                <div class="card" vertical center center-justified layout hero-id="item-{{item}}" hero?="{{$.pages.selected === item + 1 || lastSelected === item + 1}}" on-tap="{{selectView}}"><span cross-fade>{{item}}</span></div>
              </template>
            </div>
          </section>

      <template repeat="{{item in items}}">
        <section vertical layout>
          <div class="view" flex vertical center center-justified layout hero-id="item-{{item}}" hero?="{{$.pages.selected === item + 1 || $.pages.selected === 0}}"><span cross-fade>{{item}}</span>
          <core-icon-button icon="{{$.pages.selected != 0 ? 'arrow-back' : 'menu'}}" on-tap="{{back}}"></core-icon-button></div>
        </section>
      </template>
<!--       <section vertical layout hash='#0'>

        <div id="container" flex horizontal wrap around-justified layout hero-p>
        <div></div>
            <div></div>
                <div></div>
                    <div></div>
                        <div></div>
                            <div></div>
                                <div></div>
                                    <div></div>
                                        <div></div>
                                            <div></div>
                                                <div></div>
            <div class="card" vertical center center-justified layout hero-id="0-full" hero on-tap="{{selectView}}"><span cross-fade>{{item}}</span></div>
        </div>

      </section>

      <section vertical layout hash="#0/full">
          <div class="view" flex vertical center center-justified layout hero-id="0-full" hero><span cross-fade>{{item}}</span></div>
      </section> -->

    </core-animated-pages>
    </div>
<!-- layout vertical center-center -->
<!-- <div id="awesomeContent" class="content">
  <core-animated-pages  id='allPages' valueattr='hash' transitions="{{sliding}} hero-transition cross-fade">
    <template repeat="{{page in pages}}">
    <template repeat="{{page.subpages as subpage}}">
      <section id='{{ subpage.id}}' hash="#{{page.label}}/{{subpage.label}}">
        <div id="content-{{ subpage.id }}" cross-fade?="{{ full === true}}"></div>
        <footer-element id="footer-{{ subpage.id }}" narrow="{{ narrow }}" cross-fade?="{{ full === true}}"></footer-element>
      </section>

      <section id='{{subpage.id}}-full' hash="#{{page.label}}/{{subpage.label}}/full" layout vertical center-center>

        <div flex vertical center center-justified layout hero-id="hero-{{subpage.id}}" hero  class='yellow' >
          <div cross-fade>
            Hello you {{ subpage.id }}!!
          </div>
        </div>
      </section>
    </template>
  </template>
</core-animated-pages>
</div> -->
</core-header-panel>
</core-drawer-panel>
</template>

<script>
  Polymer('app-element', {
      // here we define the whole architecture of the website
      // this is enough to have the right 'empty pages'
            pages: [
            {id: 'home', label: 'home', color: '#2196F3', accent: '#1DE9B6', subpages: [
            {id:'home-introduction', label: 'introduction', element: 'introduction-element', appended: false}
            ]},
            {id: 'research', label: 'research', color: '#4CAF50', accent: '#1DE9B6', subpages: [
            {id:'research-introduction', label: 'introduction', element: 'introduction-element', appended: false},
            {id:'research-mri', label: 'mri', element: 'introduction-element', appended: false},
            {id:'research-nirs', label: 'nirs', element: 'introduction-element', appended: false},
            {id:'research-meg', label: 'meg', element: 'introduction-element', appended: false}
            ]},
            {id: 'highlights', label: 'highlights', color:'#FFC107', accent: '#1DE9B6', subpages: [
            {id:'highlights-introduction', label: 'introduction', element: 'introduction-element', appended: false},
            {id:'highlights-2014', label: '2014', element: 'highlight-element', appended: false}
            ]},
            {id: 'softwares', label: 'softwares', color:'#FF5722', accent: '#1DE9B6', subpages:[
            {id:'softwares-introduction', label: 'introduction', element: 'introduction-element', appended: false}, 
            {id:'softwares-chris', label: 'chris', element: 'introduction-element', appended: false},
            ]},
            {id: 'team', label: 'team', color: '#E91E63', accent: '#1DE9B6', subpages:[
            {id:'team-introduction', label: 'introduction', element: 'introduction-element', appended: false},
            {id:'team-faculty', label: 'faculty', element:'introduction-element', appended: false}
            ]},
            ],
            sliding: '',
            full: false,
            fulldata: {},
            firstLoad: true,
            items: [],
scrollHandler : function(event, detail, sender){
  window.console.log(event);
  window.console.log(detail);
  window.console.log(sender.scrollTop);
window.console.log('scrolling...');
},
      selectView : function(e) {
        var i = e.target.templateInstance.model.item;
        this.$.waterFallTall.mode = 'waterfall';
        this.$.pages.selected = i+1;
        
      },

      back : function() {
        
        this.lastSelected = this.$.pages.selected;
        console.log(this.lastSelected);
        this.$.pages.selected = 0;
        this.$.waterFallTall.mode = 'waterfall-tall';
      },

      transitionend : function() {
        if (this.lastSelected) {
          this.lastSelected = null;
        }
      },
            selectActionST: function(e, detail) {
              window.console.log('++++ST++++');
              window.console.log(detail);
              if (detail.isSelected) {
          // get right hash!
        }
      },
      selectActionT: function(e, detail) {
        window.console.log('++++T++++');
        window.console.log(detail);
        if (detail.isSelected) {
          // get right hash!
        }
      },
      ready: function(){
        var count=50;
      for (var i=0; i < count; i++) {
        this.items.push(i);
      }

        // this.narrow = this.$.drawerPanel.narrow;
      },
      exitFull: function(){
          this.full = false;
      },
      goFull: function(){
        this.full = true;
        window.console.log(this.full);
      },
      fulldataChanged: function(){
        window.console.log(this.fulldata);
      },
      fullChanged: function(){
        window.console.log(this.$.waterFallTall.shadowRoot.getElementById('mainContainer').scrollTop);
        window.console.log('out full');
        // add or remove full in current page url
        this.sliding = '';
        if(this.full){
          //
          this.$.drawerPanel.forceNarrow = true;
          this.updateCoreHeaderPanelStyle(true);
          // change appearance && drawer callback
          this.$.toolbarMenuIcon.icon = 'close';
          this.$.toolbarMenuIcon.removeAttribute('core-drawer-toggle');

          this.$.fullTitle.style.display = 'block';
          this.$.fullTitle.innerHTML = this.fulldata.title;
          this.$.pageTitle.style.display = 'none';

          // go
          this.$.allPages.selected = '#' + this.page.section + '/' + this.page.subsection + '/full';
        }
        else{
          this.$.drawerPanel.forceNarrow = false;
          this.updateCoreHeaderPanelStyle(false);
          // change appearance && drawer callback
          this.$.toolbarMenuIcon.icon = 'menu';
          // it breaks the animation somehow...
          this.$.toolbarMenuIcon.setAttribute('core-drawer-toggle', true);

          this.$.pageTitle.style.display = 'block';
          this.$.fullTitle.style.display = 'none';

          this.$.allPages.selected = '#' + this.page.section + '/' + this.page.subsection;
        }
      },
      slidingChanged: function(){
        window.console.log(this.sliding);
      },
      updateCoreHeaderPanelStyle: function(forceNarrow){
        if(typeof(forceNarrow) === 'undefined'){
          forceNarrow = false;
        }

        if(this.narrow || forceNarrow){
          this.$.waterFallTall.mode = 'waterfall';
        }
        else{
          this.$.waterFallTall.mode = 'waterfall-tall';
        }
      },
      narrowChanged: function(){
        this.updateCoreHeaderPanelStyle();
      },
      routeChanged: function(oldValue, newValue){
        return;
        if(this.route == null || this.route == ''){

          this.route = this.pages[0].id + '/' + this.pages[0].subpages[0].label;
        }

        var splittedRoute = newValue.split('/');

        // get previous and next pages as well
        // which section are we now?
        var prev = [0, 0];
        var cur = [0, 0];
        var next = [0, 0];
        for(var i=0; i<this.pages.length; i++){
          if(this.pages[i].id === splittedRoute[0]){
            // set color of the header
            var page = this.pages[i];
            this.$.pageToolbar.style.backgroundColor = page.color;
            for(var j=0; j<page.subpages.length; j++){
              if(page.subpages[j].label === splittedRoute[1]){
                // find previous
                if(j>0){
                  prev = [i, j-1];
                }
                else{
                  if(i>0){
                    prev = [i-1, this.pages[i-1].subpages.length - 1];
                  }
                  else{
                    prev = [0, this.pages[0].subpages.length - 1];
                  }
                }
                // find next
                if(j<page.subpages.length - 1){
                  next = [i, j+1];
                }
                else{
                  if(i<this.pages.length - 1){
                    next = [i+1, 0];
                  }
                  else{
                    // no next page
                    next = [i, j];
                  }
                }

                cur = [i, j];
                break;
              }
            }

            break;
          }
        }

        this.previousPage = {
          'section': splittedRoute[0],
          'sectionIndex': prev[0],
          'subsection': splittedRoute[1],
          'subsectionIndex': prev[1],
          'id': splittedRoute[0] + '-' + splittedRoute[1] 
        };

        this.nextPage = {
          'section': splittedRoute[0],
          'sectionIndex': next[0],
          'subsection': splittedRoute[1],
          'subsectionIndex': next[1],
          'id': splittedRoute[0] + '-' + splittedRoute[1] 
        };

        this.page = {
          'section': splittedRoute[0],
          'sectionIndex': cur[0],
          'subsection': splittedRoute[1],
          'subsectionIndex': cur[1],
          'id': splittedRoute[0] + '-' + splittedRoute[1],
          'url': this.pages[cur[0]].subpages[cur[1]].element
        };

      },
      pageChanged: function(){
        return;
        window.console.log(this.page.url);
        // select right page (core-selector, find with id-core-submenu)
        if(this.$['iam-core-menu'].selected != this.page.sectionIndex){
          this.$['iam-core-menu'].selected = this.page.sectionIndex;
        }
        this.$[this.page.section + '-core-submenu'].selected = 2*this.page.subsectionIndex;

        // set title
        this.$.myPage.innerHTML = this.page.section;
        this.$.mySubpage.innerHTML = this.page.subsection;
        var prevFooter = {
          color: this.pages[this.previousPage.sectionIndex].color,
          target: '#' + this.pages[this.previousPage.sectionIndex].id + '/' + this.pages[this.previousPage.sectionIndex].subpages[this.previousPage.subsectionIndex].label,
          label: this.pages[this.previousPage.sectionIndex].subpages[this.previousPage.subsectionIndex].label
        };
        this.$['footer-' + this.page.id].previous = prevFooter;

        var nextFooter = {
          color: this.pages[this.nextPage.sectionIndex].color,
          target: '#' + this.pages[this.nextPage.sectionIndex].id + '/' + this.pages[this.nextPage.sectionIndex].subpages[this.nextPage.subsectionIndex].label,
          label: this.pages[this.nextPage.sectionIndex].subpages[this.nextPage.subsectionIndex].label
        };
        this.$['footer-' + this.page.id].next = nextFooter;

      if(!this.pages[this.page.sectionIndex].subpages[this.page.subsectionIndex].appended){
        var node = document.createElement(this.pages[this.page.sectionIndex].subpages[this.page.subsectionIndex].element);
        node.bind('full', new PathObserver(this, 'full'));
        node.bind('fulldata', new PathObserver(this, 'fulldata'));

        this.$['content-' + this.page.id].appendChild(node);
        this.pages[this.page.sectionIndex].subpages[this.page.subsectionIndex].appended = true;
      }

      window.console.log('reset scrollTop');
      this.$.waterFallTall.shadowRoot.getElementById('mainContainer').scrollTop = 0;

      // select right page to trigger transition
      this.sliding = 'slide-from-right';
      if(this.firstLoad){
        this.firstLoad = false;
        this.sliding = '';
      }
      
      this.$.allPages.selected = '#' + this.page.section + '/' + this.page.subsection;
      }
});
</script>
</polymer-element>

