<polymer-element name="app-element">
<template>
	<link rel="stylesheet" href="app.css"> 
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

	<flatiron-director route="{{route}}" autoHash></flatiron-director>

	<core-drawer-panel id="drawerPanel" narrow='{{ narrow }}'>

	<core-header-panel drawer mode="waterfall">
	<core-toolbar id='drawerToolbar' class='core-header'> Navigation </core-toolbar>
	<core-menu on-core-select='{{selectActionT}}' id='iam-core-menu'>
	<template repeat="{{pages as page}}">
		<core-submenu on-core-select='{{ selectActionST }}' id='{{page.id}}-core-submenu' icons='settings' label="{{page.label}}">
		<template repeat="{{page.subpages as subpage}}">	
			<core-item label="{{subpage.label}}" hash="#{{page.label}}/{{subpage.label}}" ><a href="#{{page.label}}/{{subpage.label}}"></core-item>
		</template>

	</core-submenu>

</template>
</core-menu>
</core-header-panel>

<core-header-panel id='waterFallTall' main>
<core-toolbar id='pageToolbar' class="core-header">
<core-icon-button core-drawer-toggle icon="menu"></core-icon-button>
<div class="bottom indent">
	<div id='pageTitle' class='title'>
		<span id='myPage'></span>
		<i class="fa fa-angle-right"></i>
		<span id='mySubpage'></span>
	</div>
</div>
</core-toolbar>
<!-- layout vertical center-center -->
<div id="awesomeContent" class="content">
	<core-animated-pages  id='allPages' valueattr='hash' transitions="slide-from-right">
	<template repeat="{{page in pages}}">
		<template repeat="{{page.subpages as subpage}}">	
			<section id='{{ subpage.id}}' hash="#{{page.label}}/{{subpage.label}}" layout vertical center-center fit>
				{{ subpage.id }}
				<!-- should not be part of the page -->
				<footer-element id="footer-{{ subpage.id }}" narrow="{{ narrow }}"></footer-element>
				
			</section>
		</template>
	</template>
</core-animated-pages>
</div>
</core-header-panel>
</core-drawer-panel>
</template>

<script>
	Polymer('app-element', {
			// here we define the whole architecture of the website
			// this is enough to have the right 'empty pages'
		        // * COULD get that from online spreadsheet...*
		        pages: [
		        {id: 'home', label: 'home', color: '#2196F3', accent: '#1DE9B6', subpages: [
		        {id:'home-introduction', label: 'introduction', element: 'intro-element'}
		        ]},
		        {id: 'research', label: 'research', color: '#4CAF50', accent: '#1DE9B6', subpages: [
		        {id:'research-introduction', label: 'introduction', element: 'intro-element'},
		        {id:'research-mri', label: 'mri', element: 'research-element'},
		        {id:'research-nirs', label: 'nirs', element: 'research-element'},
		        {id:'research-meg', label: 'meg', element: 'research-element'}
		        ]},
		        {id: 'highlights', label: 'highlights', color:'#FFC107', accent: '#1DE9B6', subpages: [
		        {id:'highlights-introduction', label: 'introduction', element: 'intro-element'},
		        {id:'highlights-2014', label: '2014', element: 'highlight-element'}
		        ]},
		        {id: 'softwares', label: 'softwares', color:'#FF5722', accent: '#1DE9B6', subpages:[
		        {id:'softwares-introduction', label: 'introduction', element: 'intro-element'},	
		        {id:'softwares-chris', label: 'chris', element: 'software-element'},	
		        ]},
		        {id: 'team', label: 'team', color: '#E91E63', accent: '#1DE9B6', subpages:[
		        {id:'team-introduction', label: 'introduction', element: 'introduction-element', loaded:0},
		        {id:'team-faculty', label: 'faculty', element:'team-element', loaded:0}
		        ]},
		        ],
		        selectActionST: function(e, detail) {
		        	window.console.log('++++ST++++');
		        	window.console.log(detail);
		        	if (detail.isSelected) {
					// get right hash!
				}
			},
			selectActionT: function(e, detail) {
				window.console.log('++++T++++');
				window.console.log(detail);
				if (detail.isSelected) {
					// get right hash!
				}
			},
			ready: function(){
				this.narrow = this.$.drawerPanel.narrow;
			},
			narrowChanged: function(){
				if(this.narrow){
					this.$.waterFallTall.mode = 'waterfall';
				}
				else{
					this.$.waterFallTall.mode = 'waterfall-tall';
				}
			},
			routeChanged: function(oldValue, newValue){
				window.console.log(this.route);
				if(this.route == null || this.route == ''){

					this.route = this.pages[0].id + '/' + this.pages[0].subpages[0].label;
				}

				var test = newValue.split('/');

				this.page = {'section': test[0],
				'subsection': test[1],
				'id': test[0] + '-' + test[1] 
			};

		},
		pageChanged: function(){

				// which section are we now?
				var prev = [0, 0];
				var cur = [0, 0];
				var next = [0, 0];
				for(var i=0; i<this.pages.length; i++){
					if(this.pages[i].id === this.page.section){
						// set color of the header
						var page = this.pages[i];
						this.$.pageToolbar.style.backgroundColor = page.color;
						for(var j=0; j<page.subpages.length; j++){
							if(page.subpages[j].label === this.page.subsection){
								// find previous
								if(j>0){
									prev = [i, j-1];
								}
								else{
									if(i>0){
										prev = [i-1, this.pages[i-1].subpages.length - 1];
									}
									else{
										prev = [0, this.pages[0].subpages.length - 1];
									}
								}
								// find next
								if(j<page.subpages.length - 1){
									next = [i, j+1];
								}
								else{
									if(i<this.pages.length - 1){
										next = [i+1, 0];
									}
									else{
										// no next page
										next = [i, j];
									}
								}

								cur = [i, j];
								break;
							}
						}

						break;
					}
				}

				// select right page (core-selector, find with id-core-submenu)
				if(this.$['iam-core-menu'].selected != cur[0]){
					this.$['iam-core-menu'].selected = cur[0];
				}
				this.$[this.page.section + '-core-submenu'].selected = 2*cur[1];

        // set title
        this.$.myPage.innerHTML = this.page.section;
        this.$.mySubpage.innerHTML = this.page.subsection;
        var prevFooter = {
        	color: this.pages[prev[0]].color,
        	target: '#' + this.pages[prev[0]].id + '/' + this.pages[prev[0]].subpages[prev[1]].label,
        	label: this.pages[prev[0]].subpages[prev[1]].label
        };
        this.$['footer-' + this.page.id].previous = prevFooter;
        var nextFooter = {
        	color: this.pages[next[0]].color,
        	target: '#' + this.pages[next[0]].id + '/' + this.pages[next[0]].subpages[next[1]].label,
        	label: this.pages[next[0]].subpages[next[1]].label
        };
        this.$['footer-' + this.page.id].next = nextFooter;

				// select right page to trigger transition
				this.$.allPages.selected = '#' + this.page.section + '/' + this.page.subsection;
				
				this.$.waterFallTall.shadowRoot.getElementById('mainContainer').scrollTop = 0;
			}

		});
</script>
</polymer-element>
